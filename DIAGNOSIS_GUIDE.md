# 詳細レポート生成失敗の診断ガイド

## 📅 作成日
2025年10月15日

## 🎯 目的

ファイル分析で「詳細レポートの生成に失敗しました」という警告が表示される場合の診断方法と対策をまとめます。

## 🔍 現在の状況

### 成功している部分
✅ ファイルのアップロード  
✅ 基本分析（月次集計）  
✅ サマリーの表示  

### 失敗している部分
❌ 詳細な統計分析レポート  
❌ 相関分析  
❌ 回帰分析  
❌ AI洞察  

## 🔬 診断手順

### 1. バックエンドログの確認

ブラウザでファイルをアップロード後、バックエンドのターミナルを確認してください：

```bash
# 以下のようなログを探す
📂 ファイル分析開始: moc2.csv, 販売データ件数: 13810件, 地域コード: 240000
📅 販売データの最初の日付: 2022-01-01, 最後の日付: 2024-12-31
❌ 統計レポート作成エラー: (ここに具体的なエラー)
```

### 2. 考えられる原因

#### 原因A: 気象データのマッチング失敗（最も可能性が高い）

販売データの日付が気象データの日付と一致しない場合：

```
販売データ: 2022-01-01 〜 2024-12-31
気象データ: 模擬データ生成（5年前まで）
マッチング結果: 0件 / 13810件
```

**確認方法:**
```bash
# ログで以下を確認
🔗 マッチング結果: X件 / Y件
```

**解決策:**
- 販売データの日付が過去5年以内であることを確認
- 日付フォーマットが正しいことを確認（YYYY-MM-DD）

#### 原因B: Azure OpenAI API接続エラー

```
⚠️ AI分析エラー: context deadline exceeded
```

**確認方法:**
```bash
# 環境変数を確認
echo $AZURE_OPENAI_API_KEY
echo $AZURE_OPENAI_ENDPOINT
```

**解決策:**
- APIキーが有効であることを確認
- エンドポイントURLが正しいことを確認
- ネットワーク接続を確認

#### 原因C: データポイント不足

相関分析・回帰分析には最低2件のデータポイントが必要：

```
気象データとのマッチ: 1件以下
→ 統計分析不可
```

## 🛠️ 実施済みの改善

### 1. 診断情報の追加（バックエンド）

エラーメッセージに以下の情報が含まれるようになりました：
- 販売データ件数
- 気象データ取得の成否
- 具体的なエラー詳細

### 2. 警告表示の改善（フロントエンド）

バックエンドからのエラー詳細がそのまま表示されます：

```
⚠️ 警告
詳細レポートの生成に失敗しました。販売データ件数: 13810件, 
気象データ取得: 失敗, エラー詳細: ...
```

## 📊 診断チェックリスト

### データ形式の確認

- [ ] CSVファイルに「日付」列がある
- [ ] 日付がYYYY-MM-DD形式
- [ ] CSVファイルに「製品」または「製品コード」列がある
- [ ] CSVファイルに「販売数」列がある
- [ ] データが過去5年以内

### 環境の確認

- [ ] バックエンドサーバーが起動している
- [ ] Qdrantが起動している
- [ ] Azure OpenAI API環境変数が設定されている
- [ ] ネットワーク接続が正常

### ログの確認

- [ ] 「📂 ファイル分析開始」が表示される
- [ ] 「📅 販売データの最初の日付」が表示される
- [ ] エラーメッセージの詳細を確認
- [ ] 「🔗 マッチング結果」の件数を確認

## 💡 推奨される対策

### データ準備

1. **日付の確認**
   ```csv
   日付,製品コード,製品,販売数,単価,売上金額
   2023-01-01,P001,製品A,100,1000,100000
   ```

2. **期間の確認**
   - 2020年以降のデータを使用（2025年現在）
   - 最低でも30日分のデータを推奨

### エラー対応

#### ケース1: 気象データマッチング0件

**症状:**
```
🔗 マッチング結果: 0件 / 13810件
```

**対応:**
1. 日付フォーマットを確認（YYYY-MM-DD）
2. 日付が過去5年以内か確認
3. 地域コードが正しいか確認（デフォルト: 240000）

#### ケース2: AI分析エラー

**症状:**
```
⚠️ AI分析エラー: dial tcp: lookup ... no such host
```

**対応:**
1. AZURE_OPENAI_ENDPOINTを確認
2. AZURE_OPENAI_API_KEYを確認
3. ネットワーク接続を確認

#### ケース3: 統計分析エラー

**症状:**
```
❌ 統計レポート作成エラー: insufficient data points
```

**対応:**
1. より多くのデータを用意
2. 日付範囲を確認
3. データの欠損値を確認

## 🚀 次のステップ

### 即時対応

1. **ログを確認して具体的なエラーを特定**
   - バックエンドのターミナルを開く
   - ファイルをアップロード
   - エラーメッセージをコピー

2. **エラーに応じた対応**
   - 上記のケース別対応を参照
   - 必要に応じてデータを修正

### 長期的改善

1. **エラーリカバリーの実装**
   - 気象データなしでも基本分析を表示
   - 部分的な成功を許容

2. **ユーザーガイドの追加**
   - データフォーマットの説明
   - エラー時のヘルプメッセージ

3. **テストの追加**
   - 各種エラーケースのテスト
   - 境界値テスト

## 📝 サポート情報

問題が解決しない場合は、以下の情報を収集してください：

1. **バックエンドのログ全体**
2. **アップロードしたファイルのサンプル（最初の5行）**
3. **環境変数の設定状況（APIキーは除く）**
4. **フロントエンドのコンソールエラー**

これらの情報があれば、より正確な診断が可能です。

## 関連ドキュメント

- `FILE_ANALYSIS_ERROR_FIX.md`: エラーハンドリング全体の改善
- `WARNING_MESSAGE_IMPROVEMENT.md`: 警告表示の改善
- `API_MANUAL.md`: API仕様書
