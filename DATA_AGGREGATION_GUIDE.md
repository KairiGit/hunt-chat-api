# 📊 データ集約分析ガイド

HUNTシステムのデータ集約機能について説明します。

## 🎯 概要

データ集約機能により、販売データを**日次・週次・月次**の任意の粒度で集約して分析できます。

**対応ページ:**
- ✅ **製品別分析ページ** (`/product-analysis`) - 既存データの統計分析
- ✅ **ファイル分析ページ** (`/analysis`) - ファイルアップロード時の集約分析 🆕

## ✨ 主要機能

### 1. **3種類の集約粒度**

| 粒度 | 説明 | 用途 |
|------|------|------|
| **日次** (daily) | データを日別に表示 | 短期トレンド、詳細分析 |
| **週次** (weekly) | 7日間を1つの塊として集約 | 中期トレンド、週単位の計画 |
| **月次** (monthly) | 月単位で集約 | 長期トレンド、季節性分析 |

### 2. **統計分析**

各粒度で以下の統計を自動計算：

- ✅ 合計売上
- ✅ 平均売上
- ✅ 最小/最大値
- ✅ 標準偏差
- ✅ 前期間比（前日比/前週比/前月比）
- ✅ 平均気温（気象データと連携）

### 3. **トレンド分析**

- 📈 上昇/横ばい/下降の判定
- 🏆 ピーク期間・最低期間の特定
- 🌤️ 季節性パターンの検出

---

## 🚀 使い方

### ① ファイル分析での利用 🆕

**ファイルアップロード時に粒度を選択:**

1. **ファイル分析ページ**（`/analysis`）にアクセス
2. **データ集約粒度**を選択（日次/週次/月次）
   - 📅 **日次**: 詳細分析・短期トレンド
   - 📆 **週次**: 中期トレンド（推奨）⭐
   - 📊 **月次**: 長期トレンド・高速処理
3. CSVまたはExcelファイルをアップロード
4. **分析開始**ボタンをクリック

**粒度変更時のアラート:**
- 既に分析結果がある場合、粒度変更時に確認ダイアログが表示されます
- 粒度を変更すると現在の分析結果がクリアされます

### ② 製品別分析での利用

**統計分析時に粒度を選択:**

1. **製品別分析ページ**（`/product-analysis`）にアクセス
2. **集約粒度**を選択（日次/週次/月次）
3. 製品と期間を指定
4. **分析実行**ボタンをクリック

### ③ API での利用

#### ファイル分析API

```bash
POST /api/v1/ai/analyze-file
Content-Type: multipart/form-data

file: <販売データファイル>
granularity: "weekly"  // "daily", "weekly", "monthly"
```

#### 製品別分析API

```bash
POST /api/v1/ai/analyze-weekly
Content-Type: application/json

{
  "product_id": "P001",
  "start_date": "2024-01-01",
  "end_date": "2024-03-31",
  "granularity": "weekly"  // "daily", "weekly", "monthly"
}
```

**レスポンス例:**

```json
{
  "success": true,
  "data": {
    "product_id": "P001",
    "product_name": "製品A",
    "granularity": "weekly",
    "total_weeks": 13,
    "weekly_summary": [
      {
        "week_number": 1,
        "week_start": "2024-01-01",
        "week_end": "2024-01-07",
        "total_sales": 700,
        "average_sales": 100,
        "week_over_week": 0,
        "business_days": 7,
        "avg_temperature": 15.5
      }
    ],
    "overall_stats": {
      "average_weekly_sales": 720,
      "median_weekly_sales": 710,
      "std_dev_weekly_sales": 85.3,
      "best_week": 10,
      "worst_week": 3,
      "growth_rate": 15.3,
      "volatility": 0.12
    },
    "trends": {
      "direction": "上昇",
      "strength": 0.85,
      "seasonality": "後半期に需要増加傾向",
      "peak_week": 10,
      "low_week": 3,
      "average_growth": 2.8
    },
    "recommendations": [
      "第10週の好調要因を分析してください",
      "第3週の低迷要因を特定し、対策を検討してください"
    ]
  }
}
```

---

## 📋 粒度別の使い分け

### 日次分析（daily）

**最適な用途:**
- 📅 短期的な異常検知
- 🔍 詳細なパターン分析
- 🎯 日別キャンペーン効果測定

**注意点:**
- データ量が多いため処理に時間がかかる
- ノイズが多く、長期トレンドが見えにくい

**推奨期間:** 1週間〜1ヶ月

---

### 週次分析（weekly）【デフォルト・推奨】

**最適な用途:**
- 📊 中期的なトレンド把握
- 🏭 週単位の生産計画
- 📈 月次レポートの補足

**メリット:**
- ノイズが平均化され、トレンドが明確
- 営業日/休日の影響を吸収
- 分析と可視化のバランスが良い

**推奨期間:** 1ヶ月〜6ヶ月

---

### 月次分析（monthly）

**最適な用途:**
- 📆 長期トレンド分析
- 🌸 季節性パターンの把握
- 💼 経営レポート作成

**メリット:**
- 全体像が一目で把握できる
- 季節変動が明確
- データ量が少なく処理が高速

**推奨期間:** 6ヶ月〜2年

---

## 🎯 実践例

### 例1: 新製品の初動分析

```json
{
  "product_id": "P_NEW_001",
  "start_date": "2024-01-01",
  "end_date": "2024-01-31",
  "granularity": "daily"  // 初期は日次で詳細分析
}
```

**分析ポイント:**
- 発売初日の反応
- 1週間での成長率
- 週末 vs 平日の傾向

---

### 例2: 四半期レビュー

```json
{
  "product_id": "P001",
  "start_date": "2024-01-01",
  "end_date": "2024-03-31",
  "granularity": "weekly"  // 週次で中期トレンド分析
}
```

**分析ポイント:**
- 13週間の成長曲線
- ピーク週の特定
- 季節性の兆候

---

### 例3: 年間計画策定

```json
{
  "product_id": "P001",
  "start_date": "2023-01-01",
  "end_date": "2023-12-31",
  "granularity": "monthly"  // 月次で季節性分析
}
```

**分析ポイント:**
- 年間売上推移
- 繁忙期・閑散期の特定
- 前年同月比

---

## 🔧 技術詳細

### データ集約ロジック

#### 日次（daily）
- 各データポイントをそのまま表示
- 前日比を計算

#### 週次（weekly）
- 月曜始まりで7日間をグループ化
- 週内の合計・平均・標準偏差を計算
- 前週比を算出

#### 月次（monthly）
- カレンダー月単位で集約
- 月内の合計・平均・標準偏差を計算
- 前月比を算出

### データ構造

すべての粒度で共通の `WeeklySummary` 構造を使用：

```go
type WeeklySummary struct {
    WeekNumber     int     // 期間番号
    WeekStart      string  // 開始日
    WeekEnd        string  // 終了日
    TotalSales     float64 // 合計売上
    AverageSales   float64 // 平均売上
    MinSales       float64 // 最小値
    MaxSales       float64 // 最大値
    BusinessDays   int     // 営業日数
    WeekOverWeek   float64 // 前期間比（%）
    StdDev         float64 // 標準偏差
    AvgTemperature float64 // 平均気温
}
```

---

## 📊 分析結果の活用

### 1. **短期アクション（日次）**
- 異常値の即座検知
- キャンペーン効果の即時評価
- 在庫調整の緊急判断

### 2. **中期計画（週次）**
- 週次生産計画の調整
- 営業活動の優先順位付け
- リソース配分の最適化

### 3. **長期戦略（月次）**
- 季節性を考慮した年間計画
- 新製品投入のタイミング決定
- 予算配分の最適化

---

## ⚡ パフォーマンス

| 粒度 | データ量（3ヶ月） | 処理時間目安 |
|------|------------------|------------|
| 日次 | ~90データポイント | 1-2秒 |
| 週次 | ~13データポイント | <1秒 |
| 月次 | ~3データポイント | <1秒 |

**最適化のヒント:**
- 長期間の分析は月次を使用
- 詳細分析が必要な期間のみ日次を使用
- 通常の分析は週次（デフォルト）を推奨

---

## 🎨 UI機能

### 動的ラベル

粒度に応じて自動的にラベルが変更されます：

| 粒度 | 表示例 |
|------|--------|
| 日次 | "第1日", "日平均売上", "前日比" |
| 週次 | "第1週", "週平均売上", "前週比" |
| 月次 | "第1月", "月平均売上", "前月比" |

### カラーコーディング

- 🟢 **緑**: 前期間比 +5%以上
- 🔴 **赤**: 前期間比 -5%以下
- ⚫ **灰**: その他（±5%以内）

---

## 📚 関連ドキュメント

- [製品別分析ガイド](./WEEKLY_ANALYSIS_GUIDE.md) - 製品別分析の詳細（旧：週次分析）
- [ファイル形式ガイド](./FILE_FORMAT_GUIDE.md) - データフォーマット
- [API マニュアル](./API_MANUAL.md) - API仕様

---

## 💡 よくある質問

### Q: 粒度はいつでも変更できますか？

**A:** はい、同じデータセットで自由に粒度を切り替えられます。

---

### Q: 推奨される粒度は？

**A:** 以下を推奨します：
- **短期（1週間〜1ヶ月）**: 日次
- **中期（1ヶ月〜6ヶ月）**: 週次 ⭐
- **長期（6ヶ月以上）**: 月次

---

### Q: 粒度によって分析精度は変わりますか？

**A:** トレンド分析は粒度に関わらず正確です。ただし：
- **日次**: ノイズが多く、短期変動に敏感
- **月次**: 長期トレンドは明確だが、詳細が失われる
- **週次**: バランスが良く、最も実用的 ⭐

---

## 🎯 まとめ

✅ **3種類の粒度**で柔軟な分析が可能  
✅ **統計分析**とトレンド検出を自動化  
✅ **動的UI**で粒度に応じた表示  
✅ **API**でプログラム的にアクセス可能  
✅ **パフォーマンス**を考慮した設計

データの性質や目的に応じて最適な粒度を選択し、効果的な分析を実施してください！
