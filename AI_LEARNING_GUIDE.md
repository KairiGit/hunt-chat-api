# 🧠 AI学習システム - ユーザーガイド

## 📋 概要

AI学習システムは、検出された異常に対するユーザーの回答を収集・蓄積し、AIが需要変動のパターンを学習する機能です。

## ✨ 主要機能

### 1. 🔍 異常検知と質問生成
- システムが販売データから統計的異常を自動検出
- 検出された各異常に対してAIが質問を自動生成
- 深刻度（Critical/High/Medium/Low）で優先度を表示

### 2. ✍️ 回答フォーム
ユーザーが異常の原因を詳細に回答できます：

#### 回答内容
- **自由記述**: 異常の具体的な原因を詳しく説明
- **要因タグ**: 複数選択可能なカテゴリ
  - キャンペーン
  - テレビCM
  - 競合値引き
  - 気象要因
  - イベント
  - 新製品発売
  - 在庫不足
  - システム障害
  - 季節要因
  - その他

#### 影響度の入力
- **影響の方向**: プラス影響 / マイナス影響 / 中立
- **影響度（%）**: 数値で具体的に入力（例：+30%）

### 3. 🎓 AIが学習したパターン
蓄積された回答から、AIが自動的にパターンを発見：

- **カテゴリ別集計**: 要因タグごとに分析
- **平均影響度**: 各要因の平均的な需要変動率
- **信頼度**: 回答数に基づく学習の確実性
- **学習元**: 何件の実績から学習したか

### 4. 📝 回答履歴
過去の回答をすべて記録・表示：
- 日付、製品ID、回答内容
- 付与されたタグ
- 影響度
- タイムスタンプ

## 🚀 使い方

### Step 1: 異常を確認
1. `/learning` ページにアクセス
2. 左側に検出された異常が表示されます
3. 深刻度の高い順にリスト化
4. AIが生成した質問を確認

### Step 2: 異常を選択
1. 回答したい異常をクリック
2. 右側に回答フォームが表示されます

### Step 3: 回答を入力
1. **回答テキスト**: 具体的な原因を記述
   ```
   例: 新春キャンペーンを実施したため、
       通常より30%売上が増加しました
   ```

2. **要因タグ**: 該当するタグを選択（複数可）
   ```
   例: キャンペーン、テレビCM
   ```

3. **影響**: プラス/マイナス/中立を選択

4. **影響度**: パーセンテージで入力
   ```
   例: 30（30%増加の意味）
   ```

### Step 4: 保存
1. 「回答を保存してAIに学習させる」ボタンをクリック
2. データがQdrantベクトルDBに保存されます
3. AIが即座に学習を開始

### Step 5: 学習結果を確認
1. 右上の「AIが学習したパターン」カードを確認
2. 新しい洞察が追加されていることを確認
3. 信頼度が高まっていることを確認

## 📊 API エンドポイント

### 回答を保存
```http
POST /api/v1/ai/anomaly-response
Content-Type: application/json

{
  "anomaly_date": "2024-01-07",
  "product_id": "P001",
  "question": "2024-01-07に売上が急増した原因を教えてください",
  "answer": "新春キャンペーンを実施したため",
  "answer_type": "text",
  "tags": ["キャンペーン", "テレビCM"],
  "impact": "positive",
  "impact_value": 30.0
}
```

**レスポンス例**:
```json
{
  "success": true,
  "response_id": "resp_P001_2024-01-07_1704700000",
  "message": "回答を保存しました。AIが学習データとして活用します。"
}
```

### 回答履歴を取得
```http
GET /api/v1/ai/anomaly-responses?product_id=P001&limit=50
```

**レスポンス例**:
```json
{
  "success": true,
  "responses": [
    {
      "response_id": "resp_P001_2024-01-07_1704700000",
      "anomaly_date": "2024-01-07",
      "product_id": "P001",
      "question": "売上急増の原因は？",
      "answer": "新春キャンペーン実施",
      "tags": ["キャンペーン"],
      "impact": "positive",
      "impact_value": 30.0,
      "timestamp": "2025-01-08T10:00:00Z"
    }
  ],
  "total": 1,
  "message": "1件の回答履歴を取得しました"
}
```

### AI学習洞察を取得
```http
GET /api/v1/ai/learning-insights?category=キャンペーン
```

**レスポンス例**:
```json
{
  "success": true,
  "insights": [
    {
      "insight_id": "insight_1",
      "category": "キャンペーン",
      "pattern": "キャンペーンが発生した際、平均+25.5%の需要増加の傾向があります（5件の実績から学習）",
      "examples": ["2024-01-07", "2024-02-14", "2024-03-20"],
      "average_impact": 25.5,
      "confidence": 0.5,
      "learned_from": 5,
      "last_updated": "2025-01-08T10:00:00Z"
    }
  ],
  "total": 1,
  "message": "1件の学習パターンを発見しました"
}
```

## 💡 ベストプラクティス

### 回答の質を高めるコツ

1. **具体的に記述**
   - ❌ 悪い例: "キャンペーンのせい"
   - ✅ 良い例: "3日間限定の20%オフキャンペーンを実施。テレビCMも放映"

2. **数値を含める**
   - ❌ 悪い例: "たくさん売れた"
   - ✅ 良い例: "通常比30%増加、特に若年層の購入が増加"

3. **複数の要因を記載**
   - ❌ 悪い例: "キャンペーン"
   - ✅ 良い例: "キャンペーン + 好天 + 競合店休業が重なった"

4. **影響度を正確に**
   - 実績データと比較して、できるだけ正確な%を入力
   - 不明な場合は0でもOK（後で修正可能）

### タグの使い分け

| タグ | 使用例 |
|-----|-------|
| キャンペーン | 値引き、ポイント還元、セット販売 |
| テレビCM | TV広告、Web広告、SNS広告 |
| 競合値引き | 競合他社の特売、価格競争 |
| 気象要因 | 猛暑、大雨、台風、雪 |
| イベント | 祭り、スポーツイベント、地域行事 |
| 新製品発売 | 新商品リリース、リニューアル |
| 在庫不足 | 欠品、品薄、供給遅延 |
| システム障害 | ECサイト停止、POS障害 |
| 季節要因 | 年末年始、ゴールデンウィーク、お盆 |
| その他 | 上記に当てはまらない要因 |

## 🎯 学習データの活用

AIが学習したデータは以下のように活用されます：

### 1. 予測精度の向上
- 過去の同様のパターンを参照
- 「キャンペーン時は+25%」などを自動考慮

### 2. 自動質問の改善
- 頻出する要因を優先的に質問
- より具体的な選択肢を提示

### 3. 推奨事項の生成
- 「過去3回のキャンペーンでは平均+28%増加しているため、在庫を多めに確保してください」

### 4. 異常の早期検知
- 学習したパターンと一致する場合、アラートを発報
- 「来週キャンペーン予定。過去データから+30%の需要増が予想されます」

## 📈 学習の進化イメージ

```
初期状態:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
回答: 0件
洞察: 0件
予測精度: 基本的な統計モデルのみ

↓ 10件の回答を蓄積

第1段階:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
回答: 10件
洞察: 2-3パターン発見
予測精度: 主要な要因を考慮開始

↓ 50件の回答を蓄積

第2段階:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
回答: 50件
洞察: 10+パターン発見
予測精度: 複合要因を考慮可能
信頼度: 80%超

↓ 100件以上の回答を蓄積

完成状態:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
回答: 100+件
洞察: 20+パターン発見
予測精度: 高度な予測が可能
信頼度: 90%超
自動化: 多くの異常を自動説明
```

## 🔒 データ保護

- すべての回答はQdrantベクトルDBに暗号化保存
- ユーザーIDと紐付けて管理（将来の権限管理に対応）
- 回答は削除・編集可能（将来実装予定）

## 🎓 MVP要件との対応

このAI学習システムは、以下のMVP要件を満たします：

- ✅ **FR-MVP-3.1**: 異常値・変動要因の検知と対話開始
- ✅ **FR-MVP-3.2**: 対話による深掘り
- ✅ **FR-MVP-3.3**: 対話履歴の保存
- ✅ **FR-MVP-4.2**: 実績との比較とフィードバック（一部）

---

**AIと一緒に学び、より正確な需要予測を実現しましょう！🚀**
