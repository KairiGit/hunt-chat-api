要件定義

# 需要予測システム要件定義書

1. はじめに
   このドキュメントは、製造業における需要予測の精度と効率を向上させるため、経験豊富な担当者の暗黙知と AI のデータ分析能力を融合させたシステムの要件を定義するものである。本システムは、マシンパワーを抑えつつ、継続的な学習と改善を可能にすることで、予測業務の属人化解消と企業全体の予測能力向上に寄与する。

   **対象業界**: 製造業（特に消費財メーカー）
   **対象企業規模**: 中小〜大手企業（SKU数: 100-10,000品目）
   **対象ユーザー**: 需要予測担当者、営業企画担当者、生産計画担当者
   **開発期間**: 12-18ヶ月
   **予算規模**: 5,000-10,000万円
2. システムの目的

- 暗黙知の形式知化と活用: 経験豊富な担当者の直感的判断や経験則を AI との対話を通じて言語化・構造化し、予測モデルに組み込む。
- 予測精度の向上: 内部データ（販売実績、社内イベント）と外部データ（気象、景気）を多角的に分析し、人間による洞察を組み合わせることで、高精度な需要予測を実現する。
- 予測プロセスの効率化と属人化解消: 自動データ収集、AI による初期分析、対話支援により、予測作成にかかる時間を短縮し、特定の個人への依存を減らす。
- 継続的学習と改善: 実績との乖離分析とフィードバックループを通じて、AI モデルと対話ロジックを継続的に改善し、システムの予測能力を向上させる。
- マシンリソースの最適化: 複雑な深層学習に過度に依存せず、ルールベースやシンプルな統計モデル、対話による情報補完を主軸とすることで、運用コストと計算リソースを最小限に抑える。

3. 主要機能要件 (Functional Requirements)
   3.1. データ管理機能

- FR-1.1 販売実績データ連携:
  - FR-1.1.1 企業内の基幹システムまたは指定された CSV/Excel ファイルから、製品別、地域別、期間（日次、週次、月次）別の過去販売実績データを自動的または手動で取り込めること。
    - **データ形式**: CSV, Excel (.xlsx, .xls), JSON, XML
    - **必須フィールド**: 製品コード, 製品名, 販売日, 販売数量, 販売金額, 地域コード
    - **オプションフィールド**: 顧客コード, 販売チャネル, 単価, 在庫数
    - **データ取得頻度**: 日次自動取得、手動アップロード対応
    - **データ保持期間**: 最低3年分の履歴データ
  - FR-1.1.2 取り込んだ実績データの整合性をチェック（欠損値、異常値など）し、通知できること。
    - **整合性チェック項目**: 
      - 欠損値検出（必須フィールドの空白チェック）
      - 異常値検出（統計的外れ値: 3σ以上の値）
      - 重複データ検出（同一製品・日付の重複レコード）
      - 日付整合性チェック（未来日付、不正な日付形式）
    - **通知方法**: システム内通知、メール通知、Slack通知
    - **エラー処理**: 自動修正可能な項目と手動確認必要な項目の分類
- FR-1.2 外部データ自動連携:
  - FR-1.2.1 気象データ（例：気温、降水量、湿度、日照時間）を、指定された予測対象地域（例：鈴鹿市）に紐づけて自動で取得し、販売実績データと紐付けて管理できること。
    - **データソース**: 気象庁API、OpenWeatherMap API、WeatherAPI
    - **取得データ項目**: 
      - 日別: 最高気温、最低気温、平均気温、降水量、湿度、風速、日照時間
      - 週別: 上記項目の週平均値
      - 月別: 上記項目の月平均値
    - **地域設定**: 都道府県、市区町村単位での設定可能
    - **取得頻度**: 日次自動取得（朝6時実行）
    - **データ保持**: 5年分の履歴データ
  - FR-1.2.2 景気関連データ（例：消費者物価指数 (CPI)、生産者物価指数 (PPI)、GDP 成長率、製造業 PMI、消費者信頼感指数など）を信頼できる公開データソースから自動で取得し、管理できること。
    - **データソース**: 
      - 総務省統計局API（CPI）
      - 内閣府API（GDP関連）
      - 日本銀行API（金融統計）
      - 帝国データバンクAPI（景気動向指数）
    - **取得データ項目**:
      - 消費者物価指数（総合、食料、エネルギー別）
      - 生産者物価指数（製造業、原材料別）
      - GDP成長率（四半期、年率）
      - 完全失業率
      - 消費者信頼感指数
      - 製造業PMI
    - **取得頻度**: 月次自動取得（各統計発表日の翌日）
    - **データ形式**: JSON形式で統一管理
- FR-1.3 ユーザー手動入力外部データ:
  - FR-1.3.1 為替レート、特定の原材料価格、競合他社の特売・新製品発表、市場調査レポート、業界特有のイベント情報など、自動連携が難しいが予測に影響する外部データをユーザーが手動で入力・更新できること。
  - FR-1.3.2 入力されたデータに、影響期間や関連製品、影響度（定性的な選択肢可）を付与できること。
- FR-1.4 社内ニュース・イベント情報登録:
  - FR-1.4.1 新製品発売、既存製品のリニューアル、新規顧客獲得、主要顧客の生産計画変更、特定の地域イベントへの出展、大規模な社内プロモーション、メディア掲載など、需要に影響を与える社内固有のイベント情報をユーザーがタイムライン形式で登録・管理できること。
  - FR-1.4.2 登録時に、イベントの種類、具体的な内容、開始・終了期間、関連製品、予測への影響度（定性的な選択肢：大、中、小など）を付与できること。
    3.2. 予測生成・提示機能
- FR-2.1 初期予測生成:
  - FR-2.1.1 連携された販売実績データに基づき、トレンド、季節性、周期性を考慮した初期的な需要予測値（例：ARIMA、指数平滑法などシンプルな統計モデルを使用）を自動で生成できること。
  - FR-2.1.2 予測期間（週次、月次など）と予測粒度（製品カテゴリ、個別製品など）を設定できること。
- FR-2.2 異常値・変動要因の検知と提示:
  - FR-2.2.1 過去の販売実績データにおいて、統計的に有意な異常値や急激な売上変動（急増・急減）を自動で検出し、システム上でハイライト表示できること。
  - FR-2.2.2 検出された変動に対し、自動連携した気象データや景気関連データとの相関を自律的に分析し、可能性のある要因（例：「この期間の売上増加は、例年より高い気温と相関が見られます」）を仮説として提示できること。
- FR-2.3 予測可視化:
  - FR-2.3.1 初期予測値、販売実績、登録されたイベント情報、主要な外部データをインタラクティブなグラフ（折れ線グラフ、棒グラフなど）で視覚的に表示できること。
  - FR-2.3.2 期間のズームイン/アウト、製品フィルタリング、要因のオン/オフ表示など、データ探索のための柔軟な表示オプションを提供すること。
    3.3. 暗黙知言語化・対話支援機能
- FR-3.1 タイムライン連動型質問:
  - FR-3.1.1 検出された異常値や急激な変動期間に対し、AI が自動で**「この期間（例：昨年 7 月第 3 週）に売上が急増していますが、何か特別な出来事がありましたか？」**のように、具体的な期間と変動を示して担当者に問いかけること。
  - FR-3.1.2 質問時に、多様な要因例（例：テレビ CM、競合製品のリコール、異常気象、社内キャンペーンなど）を提示し、担当者の記憶想起を支援できること。
- FR-3.2 シナリオベースの仮説検証:
  - FR-3.2.1 AI が特定の未来シナリオ（例：「もし来月、特定の競合製品が 20%値引きされた場合」）を提示し、それに対する需要の影響度を、担当者に選択肢（例：ほとんど影響なし、軽微な減少、中程度の減少、大きな減少）または数値で入力させること。
  - FR-3.2.2 担当者が選択または入力した後、AI が**「そのように判断された具体的な理由や根拠は何ですか？」**と、その判断に至る思考プロセスを自然言語で問いかけること。
- FR-3.3 因果関係の逆引き質問:
  - FR-3.3.1 予測と実績の乖離（予測の上振れ/下振れ）や、実績の急変動に対し、AI が**「今回の『予測外れ』の主な要因は何だとお考えですか？」「その判断に至った具体的な兆候や情報源は？」**といった形で、原因となる要因を担当者から引き出すこと。
  - FR-3.3.2 担当者の回答を受け、AI がその内容を要約し、「それはつまり、○○ が起因しているということですね？」のように確認することで、認識のすり合わせと言語化の支援を行うこと。
- FR-3.4 質問の具体化・誘導:
  - FR-3.4.1 担当者の回答が「なんとなく」「勘」といった抽象的な場合、AI がより具体的・限定的な質問を段階的に投げかけ、暗黙知を具体的な情報に落とし込むように誘導できること。
  - FR-3.4.2 Yes/No 形式や複数選択肢形式の質問を効果的に活用し、担当者の回答負担を軽減しつつ、情報を引き出せること。
- FR-3.5 対話履歴の保存:
  - FR-3.5.1 AI と担当者とのすべての対話履歴を保存し、後から参照できること。
    3.4. 予測調整・学習機能
- FR-4.1 予測値の手動調整と理由付与:
  - FR-4.1.1 AI が提示した予測値に対し、担当者が自身の判断に基づき、期間、製品、数量を指定して手動で調整（上書き）できること。
  - FR-4.1.2 調整を行った際には、その調整理由を自由記述またはタグ付けで入力できること。
- FR-4.2 フィードバックループと継続的学習:
  - FR-4.2.1 実際の販売実績が確定した後、システムが予測値と実績を自動で比較し、その乖離を自動で分析できること。
  - FR-4.2.2 乖離が発生した場合、AI がその原因（例：対話で得られた情報の不足、モデルの精度不足など）を分析し、次回の予測生成時や対話ロジックの改善にフィードバックできること。
  - FR-4.2.3 担当者との対話で得られたイベントの影響度、要因の因果関係、担当者の判断基準などを、ルールベースやシンプルな統計モデルのパラメータとして学習し、継続的に予測精度を向上できること。
  - FR-4.2.4 特に、ユーザーが手動で登録した社内ニュースやイベント情報は、その後の販売実績との相関を学習し、個々のイベントが需要に与える影響度を定量的に把握できるようになること。

4. 非機能要件 (Non-Functional Requirements)
   4.1. パフォーマンス

- NFR-1.1 予測生成速度: 初期予測生成および AI による調整後の予測生成は、数分以内（例：1000SKU あたり 5 分以内）に完了すること。
  - **測定方法**: 1000SKU、過去3年分データでの処理時間測定
  - **許容範囲**: 平均4分以内、最大5分以内
  - **負荷条件**: 同時実行数3以下での測定
- NFR-1.2 レスポンスタイム: ユーザーインターフェース操作時および AI との対話時の応答時間は、体感として遅延を感じさせないこと（例：2 秒以内）。
  - **画面表示**: 初期表示2秒以内、画面遷移1秒以内
  - **対話AI**: 質問投稿から回答表示まで2秒以内
  - **グラフ描画**: 1000点以下のデータで1秒以内
- NFR-1.3 マシンリソース効率: 運用に必要な CPU、メモリ、ストレージリソースを最小限に抑える設計であること。
  - **CPU**: 本番環境で4コア以下
  - **メモリ**: 16GB以下
  - **ストレージ**: 初期500GB、年間100GB増加
  - **データベース**: 接続数50以下で安定動作
  4.2. ユーザビリティ (UI/UX)
- NFR-2.1 直感的なインターフェース: 専門知識がなくても直感的に操作できる、シンプルで分かりやすいユーザーインターフェースを提供すること。
- NFR-2.2 対話の自然さ: AI との対話は、不自然な機械的応答ではなく、自然言語に近い形でスムーズに進むこと。
- NFR-2.3 視覚的表現: 予測データ、実績データ、イベント情報、相関分析結果などを、グラフやタイムラインなどを用いて視覚的に分かりやすく表示できること。
- NFR-2.4 エラーハンドリング: ユーザーの誤入力やデータエラーに対して、分かりやすいメッセージで通知し、適切な対応を促すこと。
  4.3. 信頼性・可用性
- NFR-3.1 データバックアップ: 全てのデータ（販売実績、外部データ、対話履歴、予測モデル）は定期的にバックアップされ、障害発生時には復旧できること。
- NFR-3.2 システム稼働率: 目標稼働率は 99.9%以上であること。
- NFR-3.3 障害回復: システム障害発生時も、迅速に復旧できる仕組みが構築されていること。
  4.4. セキュリティ
- NFR-4.1 アクセス制御: ユーザー認証機能を持ち、役割に応じたアクセス権限（例：管理者、予測担当者）を設定できること。
- NFR-4.2 データ保護: 販売実績や社内ニュースなど、機密性の高いデータを暗号化するなどして保護し、不正アクセスや情報漏洩から守ること。
- NFR-4.3 監査ログ: ユーザー操作や重要なシステムイベントのログを記録し、監査できること。
  4.5. 拡張性・保守性
- NFR-5.1 モジュール性: 各機能が独立したモジュールとして設計されており、将来的な機能追加や変更が容易であること。
- NFR-5.2 データソースの柔軟性: 新たな外部データソースや社内システムとの連携が比較的容易に行える構造であること。
- NFR-5.3 学習ロジックの改善: AI の学習アルゴリズムや対話ロジックを、継続的なフィードバックに基づいて改善・調整できる柔軟性を持つこと。
  4.6. 環境要件
- NFR-6.1 クラウドベース: 特定のハードウェアに依存せず、クラウド環境（例：AWS, Azure, GCP）で運用可能であること。
- NFR-6.2 ブラウザ互換性: 主要なウェブブラウザ（Chrome, Firefox, Edge など）で正常に動作すること。

5. システム構成とアーキテクチャ

5.1. 技術スタック
- **フロントエンド**: React.js + TypeScript, Chart.js/D3.js（データ可視化）
- **バックエンド**: Go言語（Gin framework）
- **データベース**: PostgreSQL（実績データ、設定データ）, Redis（キャッシュ）
- **AI/ML**: Azure OpenAI（対話AI）, Python（統計分析）
- **インフラ**: Azure Container Instances, Azure Database for PostgreSQL
- **API**: RESTful API, WebSocket（リアルタイム対話）

5.2. システムアーキテクチャ
```
[フロントエンド]
     ↓ HTTPS/WebSocket
[API Gateway]
     ↓
[アプリケーション層]
├── 予測エンジン
├── 対話エンジン
├── データ収集サービス
└── 学習サービス
     ↓
[データ層]
├── PostgreSQL（メインDB）
├── Redis（キャッシュ）
└── Azure Blob Storage（ファイル）
     ↓
[外部連携]
├── 気象データAPI
├── 景気データAPI
└── 基幹システム
```

5.3. データモデル設計
- **sales_records**: 販売実績データ
- **weather_data**: 気象データ
- **economic_data**: 景気データ
- **events**: 社内イベント情報
- **predictions**: 予測結果
- **conversations**: 対話履歴
- **learning_rules**: 学習ルール

6. ユーザーストーリー

6.1. 需要予測担当者（メインユーザー）
- **US-1**: 「毎月の予測作成時間を現在の8時間から4時間に短縮したい」
- **US-2**: 「過去の異常値について、AIから具体的な要因を質問してほしい」
- **US-3**: 「競合の動向や季節要因を考慮した予測調整を効率的に行いたい」
- **US-4**: 「予測精度を現在の70%から85%以上に向上させたい」

6.2. 営業企画担当者
- **US-5**: 「営業イベントの効果を予測に反映させたい」
- **US-6**: 「地域別の需要動向を視覚的に把握したい」

6.3. 生産計画担当者
- **US-7**: 「需要予測の信頼区間を含めた生産計画を立てたい」
- **US-8**: 「予測変更時の生産への影響度を知りたい」

7. 受入条件（Acceptance Criteria）

7.1. 機能面
- **AC-1**: 1000SKUの予測生成が5分以内で完了すること
- **AC-2**: 予測精度（MAPE）が既存手法より10%以上向上すること
- **AC-3**: 異常値検出の精度が95%以上であること
- **AC-4**: 対話AIの応答が2秒以内であること
- **AC-5**: データ取得失敗時の復旧が自動で行われること

7.2. 性能面
- **AC-6**: 同時利用者数50名での正常動作
- **AC-7**: 99.9%以上の稼働率
- **AC-8**: データベース応答時間が100ms以内
- **AC-9**: ファイルアップロード（10MB）が30秒以内

7.3. セキュリティ面
- **AC-10**: HTTPS通信の強制
- **AC-11**: JWT認証による認証機能
- **AC-12**: データ暗号化（AES-256）
- **AC-13**: 操作ログの完全記録

8. テストケース例

8.1. 機能テスト
- **TC-1**: CSV形式販売データの正常取り込み
- **TC-2**: 異常値を含むデータの検出とエラー表示
- **TC-3**: 気象データAPI連携の正常動作
- **TC-4**: 予測モデルの計算結果検証
- **TC-5**: 対話AIの自然言語理解精度

8.2. 性能テスト
- **TC-6**: 大量データ（100万件）処理時の性能
- **TC-7**: 同時アクセス負荷テスト
- **TC-8**: メモリ使用量の測定

8.3. セキュリティテスト
- **TC-9**: 不正アクセス試行の検出
- **TC-10**: SQLインジェクション攻撃の防御
- **TC-11**: データ漏洩テスト

9. 運用要件

9.1. 監視項目
- **システム稼働状況**: CPU使用率、メモリ使用率、ディスク使用率
- **アプリケーション**: 応答時間、エラー率、API呼び出し回数
- **データベース**: 接続数、クエリ実行時間、デッドロック発生数
- **外部API**: 連携成功率、レスポンス時間

9.2. バックアップ・リカバリ
- **データベース**: 日次フルバックアップ、時間別差分バックアップ
- **ファイル**: 週次バックアップ
- **設定情報**: 変更時点でのバックアップ
- **復旧時間目標**: RTO 4時間、RPO 1時間

9.3. 保守・メンテナンス
- **定期メンテナンス**: 月1回、土日夜間実施
- **セキュリティアップデート**: 緊急時は24時間以内適用
- **機能追加**: 四半期ごとのリリース
- **サポート体制**: 平日9-18時、重要障害は24時間対応

10. API仕様例

10.1. 販売実績データAPI
```
POST /api/v1/sales/upload
Content-Type: multipart/form-data
Parameters:
- file: CSV/Excel file
- format: "csv" | "excel"
- has_header: boolean

Response:
{
  "success": true,
  "processed_records": 1000,
  "errors": [
    {
      "row": 5,
      "column": "sales_amount",
      "message": "Invalid number format"
    }
  ]
}
```

10.2. 予測生成API
```
POST /api/v1/predictions/generate
Content-Type: application/json
{
  "product_ids": ["P001", "P002"],
  "period": "monthly",
  "forecast_months": 3,
  "include_confidence_interval": true
}

Response:
{
  "predictions": [
    {
      "product_id": "P001",
      "forecasts": [
        {
          "period": "2025-08",
          "predicted_value": 1200,
          "confidence_interval": {
            "lower": 1000,
            "upper": 1400
          }
        }
      ]
    }
  ]
}
```

10.3. 対話API
```
POST /api/v1/conversation/message
Content-Type: application/json
{
  "session_id": "session_123",
  "message": "7月の売上が急増した理由は何ですか？",
  "context": {
    "product_id": "P001",
    "period": "2024-07"
  }
}

Response:
{
  "response": "7月の売上急増について確認させてください。この期間に特別なプロモーションやイベントはありましたか？",
  "suggestions": [
    "テレビCMの放映",
    "特別価格での販売",
    "競合商品の問題",
    "季節要因"
  ]
}
```

11. データベーススキーマ例

11.1. sales_records テーブル
```sql
CREATE TABLE sales_records (
    id SERIAL PRIMARY KEY,
    product_id VARCHAR(50) NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    sale_date DATE NOT NULL,
    quantity INTEGER NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    region_code VARCHAR(10),
    customer_id VARCHAR(50),
    channel VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sales_product_date ON sales_records(product_id, sale_date);
CREATE INDEX idx_sales_date ON sales_records(sale_date);
```

11.2. predictions テーブル
```sql
CREATE TABLE predictions (
    id SERIAL PRIMARY KEY,
    product_id VARCHAR(50) NOT NULL,
    forecast_date DATE NOT NULL,
    predicted_value DECIMAL(12,2) NOT NULL,
    confidence_lower DECIMAL(12,2),
    confidence_upper DECIMAL(12,2),
    model_type VARCHAR(50),
    accuracy_score DECIMAL(5,4),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(50)
);
```

11.3. conversations テーブル
```sql
CREATE TABLE conversations (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(100) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    message_type VARCHAR(20) NOT NULL, -- 'user' or 'ai'
    content TEXT NOT NULL,
    context_data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

12. 段階的開発計画

12.1. Phase 1（開発期間: 1-4ヶ月）
- **目標**: 基本的な予測機能とデータ管理
- **機能**: 
  - 販売実績データの取り込み
  - 基本的な統計予測（移動平均、線形トレンド）
  - 簡易的な可視化
  - ユーザー認証機能
- **成果物**: MVP（Minimum Viable Product）

12.2. Phase 2（開発期間: 5-8ヶ月）
- **目標**: 外部データ連携とAI対話機能
- **機能**:
  - 気象データ自動取得
  - 基本的な対話AI機能
  - 異常値検出
  - 予測精度向上（ARIMA、指数平滑法）
- **成果物**: β版システム

12.3. Phase 3（開発期間: 9-12ヶ月）
- **目標**: 高度な学習機能と運用最適化
- **機能**:
  - 景気データ連携
  - 高度な対話ロジック
  - 継続学習機能
  - パフォーマンス最適化
- **成果物**: 本番リリース版

12.4. Phase 4（開発期間: 13-18ヶ月）
- **目標**: 運用改善と機能拡張
- **機能**:
  - 運用監視機能
  - 追加の統計モデル
  - モバイル対応
  - 高度な可視化機能
- **成果物**: 運用安定版

13. リスクと対策

13.1. 技術的リスク
- **リスク**: 外部API（気象データ等）の仕様変更
- **対策**: 複数のデータソースの準備、アダプターパターンの採用

- **リスク**: 予測精度の向上が期待値に届かない
- **対策**: 複数の予測モデルの併用、人間の判断との組み合わせ強化

13.2. 運用リスク
- **リスク**: データの品質問題
- **対策**: 厳格なデータ検証ルール、データクレンジング機能

- **リスク**: ユーザーの操作習得困難
- **対策**: 段階的な機能公開、十分なユーザートレーニング

13.3. 事業リスク
- **リスク**: 既存業務プロセスとの不整合
- **対策**: 現行業務の詳細分析、段階的な移行計画

14. 成功指標（KPI）

14.1. 予測精度指標
- **MAPE（Mean Absolute Percentage Error）**: 現在30% → 目標20%以下
- **予測的中率**: 80%以上（±10%の誤差範囲内）
- **異常値検出率**: 95%以上

14.2. 業務効率指標
- **予測作成時間**: 現在8時間 → 目標4時間以下
- **データ処理時間**: 手動2時間 → 自動10分以内
- **システム利用率**: 月間80%以上

14.3. システム品質指標
- **稼働率**: 99.9%以上
- **レスポンス時間**: 平均2秒以内
- **エラー発生率**: 0.1%以下

———

## 付録A: API層とアプリケーション層の責任分界点

### A.1. アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                  フロントエンド側                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   Web UI        │  │  Mobile App     │  │  BI Dashboard   ││
│  │  (React.js)     │  │  (React Native) │  │  (Tableau等)    ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
                              │
                    HTTPS / REST API
                              │
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway層                           │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  - 認証・認可 (JWT)                                     ││
│  │  - レート制限                                           ││
│  │  - ログ・監視                                           ││
│  │  - CORS設定                                             ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   API層 (Go + Gin)                         │
│  ┌────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │ REST API       │  │ WebSocket API   │  │ GraphQL API     ││
│  │ エンドポイント  │  │ (リアルタイム)  │  │ (柔軟なクエリ)  ││
│  └────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  ビジネスロジック層                          │
│  ┌────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │ 予測エンジン    │  │ 対話エンジン    │  │ 学習エンジン    ││
│  │ (統計・ML)     │  │ (AI・NLP)      │  │ (継続学習)      ││
│  └────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### A.2. API層の責任範囲

#### A.2.1. 提供するAPI機能

**1. データ管理API**
```go
// 販売実績データ
POST   /api/v1/sales/upload          // データアップロード
GET    /api/v1/sales                 // 販売データ取得
PUT    /api/v1/sales/{id}            // データ更新
DELETE /api/v1/sales/{id}            // データ削除
GET    /api/v1/sales/validate        // データ検証

// 外部データ連携
GET    /api/v1/external/weather      // 気象データ取得
GET    /api/v1/external/economic     // 景気データ取得
POST   /api/v1/external/manual       // 手動データ登録

// 社内イベント
GET    /api/v1/events                // イベント一覧
POST   /api/v1/events                // イベント登録
PUT    /api/v1/events/{id}           // イベント更新
DELETE /api/v1/events/{id}           // イベント削除
```

**2. 予測生成API**
```go
// 予測生成
POST   /api/v1/predictions/generate   // 予測生成実行
GET    /api/v1/predictions/{id}       // 予測結果取得
PUT    /api/v1/predictions/{id}       // 予測調整
DELETE /api/v1/predictions/{id}       // 予測削除

// 異常値検出
GET    /api/v1/anomalies              // 異常値一覧
POST   /api/v1/anomalies/detect       // 異常値検出実行
GET    /api/v1/anomalies/{id}/factors // 要因分析結果
```

**3. 対話API**
```go
// チャット対話
POST   /api/v1/chat/message          // メッセージ送信
GET    /api/v1/chat/history          // 対話履歴取得
POST   /api/v1/chat/session          // セッション開始
DELETE /api/v1/chat/session/{id}     // セッション終了

// WebSocket (リアルタイム対話)
WS     /api/v1/chat/ws               // WebSocket接続
```

**4. 分析・レポートAPI**
```go
// 予測精度分析
GET    /api/v1/analytics/accuracy     // 精度分析結果
GET    /api/v1/analytics/performance  // 性能分析
GET    /api/v1/analytics/usage        // 利用状況分析

// レポート生成
GET    /api/v1/reports/forecast       // 予測レポート
GET    /api/v1/reports/accuracy       // 精度レポート
POST   /api/v1/reports/custom         // カスタムレポート
```

#### A.2.2. API層が処理する機能

**データ処理・変換**
- CSVファイルのパース・バリデーション
- データフォーマット変換（CSV→JSON、Excel→JSON）
- 外部APIからのデータ取得・正規化
- データ整合性チェック・エラーハンドリング

**認証・認可**
- JWTトークン検証
- ロールベースアクセス制御（RBAC）
- APIキー管理
- セッション管理

**ビジネスロジック実行**
- 統計モデル（ARIMA、指数平滑法）実行
- 異常値検出アルゴリズム実行
- 相関分析処理
- 予測値計算

**外部連携**
- 気象データAPI呼び出し
- 景気データAPI呼び出し
- Azure OpenAI API呼び出し
- 基幹システム連携

### A.3. アプリケーション層の責任範囲

#### A.3.1. フロントエンド側の実装

**UI/UX機能**
```javascript
// React.js コンポーネント例
// データ可視化
<ForecastChart 
  data={forecastData}
  interactive={true}
  zoom={true}
  filter={true}
/>

// 対話インターフェース
<ChatInterface
  sessionId={sessionId}
  onMessage={handleMessage}
  suggestions={suggestions}
/>

// データ入力フォーム
<DataUploadForm
  onUpload={handleUpload}
  validationRules={validationRules}
  formats={['csv', 'excel']}
/>
```

**状態管理**
```javascript
// Redux/Context API での状態管理
const initialState = {
  forecasts: [],
  conversations: [],
  userData: null,
  loading: false,
  errors: []
};

// API呼び出し
const fetchForecast = async (productId) => {
  const response = await api.post('/api/v1/predictions/generate', {
    product_id: productId,
    period: 'monthly',
    forecast_months: 3
  });
  return response.data;
};
```

**データ可視化**
```javascript
// Chart.js / D3.js による可視化
const ChartComponent = ({ data, type }) => {
  const chartConfig = {
    type: type,
    data: {
      labels: data.labels,
      datasets: [{
        label: '予測値',
        data: data.predictions,
        borderColor: '#36A2EB',
        backgroundColor: 'rgba(54, 162, 235, 0.1)'
      }]
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      scales: {
        x: { display: true },
        y: { display: true }
      }
    }
  };
  
  return <Chart config={chartConfig} />;
};
```

#### A.3.2. アプリケーション固有の処理

**画面遷移・ルーティング**
```javascript
// React Router による画面遷移
<Routes>
  <Route path="/dashboard" element={<Dashboard />} />
  <Route path="/forecasts" element={<ForecastList />} />
  <Route path="/forecasts/:id" element={<ForecastDetail />} />
  <Route path="/chat" element={<ChatInterface />} />
  <Route path="/settings" element={<Settings />} />
</Routes>
```

**クライアント側バリデーション**
```javascript
// フォームバリデーション
const validateUploadFile = (file) => {
  const validTypes = ['text/csv', 'application/vnd.ms-excel'];
  const maxSize = 10 * 1024 * 1024; // 10MB
  
  if (!validTypes.includes(file.type)) {
    return { valid: false, error: 'サポートされていないファイル形式' };
  }
  
  if (file.size > maxSize) {
    return { valid: false, error: 'ファイルサイズが大きすぎます' };
  }
  
  return { valid: true };
};
```

**キャッシュ管理**
```javascript
// React Query / SWR によるキャッシュ
const { data: forecasts, isLoading, error } = useQuery(
  ['forecasts', productId],
  () => fetchForecast(productId),
  {
    staleTime: 5 * 60 * 1000, // 5分
    cacheTime: 10 * 60 * 1000, // 10分
    refetchOnWindowFocus: false
  }
);
```

### A.4. 具体的な実装例

#### A.4.1. API側の実装例

```go
// handlers/forecast.go
type ForecastHandler struct {
    forecastService *services.ForecastService
    chatService     *services.ChatService
}

func (h *ForecastHandler) GenerateForecast(c *gin.Context) {
    var req models.ForecastRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }
    
    // ビジネスロジック実行
    result, err := h.forecastService.Generate(req)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    c.JSON(200, result)
}

func (h *ForecastHandler) DetectAnomalies(c *gin.Context) {
    productID := c.Param("product_id")
    
    // 異常値検出処理
    anomalies, err := h.forecastService.DetectAnomalies(productID)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    c.JSON(200, gin.H{
        "anomalies": anomalies,
        "count": len(anomalies),
    })
}
```

#### A.4.2. アプリケーション側の実装例

```javascript
// components/ForecastDashboard.jsx
import React, { useState, useEffect } from 'react';
import { useForecast } from '../hooks/useForecast';
import ForecastChart from './ForecastChart';
import ChatInterface from './ChatInterface';

const ForecastDashboard = () => {
  const [selectedProduct, setSelectedProduct] = useState(null);
  const { forecast, loading, error, generateForecast } = useForecast();

  const handleProductSelect = (productId) => {
    setSelectedProduct(productId);
    generateForecast(productId);
  };

  const handleChatMessage = async (message) => {
    // API呼び出し
    const response = await fetch('/api/v1/chat/message', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        message,
        context: { product_id: selectedProduct }
      })
    });
    
    return response.json();
  };

  return (
    <div className="dashboard">
      <div className="forecast-section">
        <ForecastChart 
          data={forecast}
          loading={loading}
          error={error}
        />
      </div>
      
      <div className="chat-section">
        <ChatInterface
          onMessage={handleChatMessage}
          context={{ product_id: selectedProduct }}
        />
      </div>
    </div>
  );
};
```

### A.5. 責任分界点の明確化

#### A.5.1. API層の責任
✅ **処理する機能**
- データの永続化・取得
- ビジネスロジックの実行
- 外部API連携
- 認証・認可
- データ変換・正規化
- エラーハンドリング
- ログ記録

#### A.5.2. アプリケーション層の責任
✅ **処理する機能**
- ユーザーインターフェース
- 画面遷移・ルーティング
- クライアント側バリデーション
- データ可視化
- 状態管理
- キャッシュ管理
- ユーザー体験の最適化

#### A.5.3. 境界が曖昧な領域
⚠️ **検討が必要な機能**
- **リアルタイム処理**: WebSocketでの対話
- **大量データ処理**: ページング、フィルタリング
- **複雑な計算**: クライアント側での前処理
- **キャッシュ戦略**: API側 vs クライアント側

### A.6. 開発・運用上の考慮事項

#### A.6.1. API設計の原則
- RESTful設計の遵守
- 適切なHTTPステータスコードの使用
- 統一されたエラーレスポンス形式
- バージョニング戦略（/api/v1/...）
- 適切なページネーション

#### A.6.2. パフォーマンス考慮
- APIレスポンスサイズの最適化
- 適切なキャッシュ戦略
- 非同期処理の活用
- データベースクエリの最適化

この分析により、API層とアプリケーション層の明確な責任分界点が定義され、開発チームが効率的に作業を分担できるようになります。
