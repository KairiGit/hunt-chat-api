# 実装済みアーキテクチャに基づくワークフロー

このドキュメントは、現在実装されているRAG (Retrieval-Augmented Generation) の具体的なアーキテクチャとワークフローを記述します。

## 1. 現在のアーキテクチャ

システムは、以下のコンポーネントで構成されています。

- **AIモデル (Azure OpenAI Service)**
  - **チャットモデル (`gpt-4o-mini`)**: ユーザーとの対話や、最終的な回答の生成を担当します。
  - **Embeddingモデル (`text-embedding-3-small`)**: テキストをベクトル（数値の配列）に変換し、意味の近さを計算可能にする役割を担います。

- **長期記憶 (ローカルVector DB)**
  - **Qdrant (Docker)**: チャットでの対話履歴をベクトルとして保存します。AIは新しい質問が来た際に、この「長期記憶」を参照して類似した過去の会話を思い出すことができます。

- **ネットワーク構成**
  - **プロキシサーバー**: Azure OpenAI Serviceへのすべてのリクエストは、特殊な仕様を持つプロキシサーバーを経由します。Goアプリケーションは、このプロキシのURLを最終的な宛先（エンドポイント）として設定する必要があります。

---

## 2. 実装済みワークフロー (チャット機能)

現在、チャット機能において以下のRAGパイプラインが実装されています。

### ステップ 1：ユーザーからの質問

ユーザーがチャットインターフェースで質問を入力します。（例：「A製品の特徴を教えて」）

### ステップ 2：過去の記憶の検索 (Search)

1.  **質問のベクトル化**: バックエンドは、まずユーザーの質問「A製品の特徴を教えて」を、Azure OpenAIの**Embeddingモデル**に送り、質問の意味を表すベクトルに変換します。
2.  **類似情報の検索**: 次に、そのベクトルを使って、ローカルの**Qdrant**に保存されている過去の会話履歴の中から、意味的に最も類似した情報（過去の質問や回答）を検索します。

### ステップ 3：AIへのコンテキスト提供

バックエンドは、AIに渡すプロンプト（指示書）を動的に作成します。これには以下の情報が含まれます。

- **ユーザーの現在の質問**: 「A製品の特徴を教えて」
- **（もしあれば）ファイル分析の結果**: 事前にアップロードされたファイルがあれば、その分析サマリー。
- **（もし見つかれば）類似した過去の会話**: ステップ2でQdrantから検索した過去の会話内容。

### ステップ 4：AIによる回答生成

バックエンドは、ステップ3で作成したプロンプトをAzure OpenAIの**チャットモデル** (`gpt-4o-mini`) に送信します。
AIは、提供されたすべてのコンテキスト（過去の会話など）を考慮して、より的確で文脈に沿った回答を生成します。

### ステップ 5：新しい記憶の保存 (Save)

1.  **会話のベクトル化**: ユーザーの質問と、AIが生成した回答は、それぞれバックグラウンドで**Embeddingモデル**によってベクトル化されます。
2.  **Qdrantへの保存**: 生成されたベクトルは、元のテキストと共に**Qdrant**に保存されます。

これにより、今回の会話がAIの新しい「長期記憶」となり、将来の質問に対して再利用されるようになります。

---

## 3. 実装コンポーネントのサマリー

- **フロントエンド**: Next.js
- **バックエンド**: Go (Ginフレームワーク)
- **AIモデル**: Azure OpenAI Service
- **Vector DB**: Qdrant (Dockerコンテナとしてローカルで実行)
- **主要なGoパッケージ**:
  - `pkg/azure/openai.go`: Azure OpenAI APIとの通信を管理するクライアント。エンドポイントをプロキシURLとして扱う特殊な構成に対応済み。
  - `internal/services/vector_store_service.go`: テキストのベクトル化と、Qdrantへの保存(Save)・検索(Search)を行うRAGの中核サービス。
  - `internal/handlers/ai_handler.go`: チャットリクエストを受け取り、RAGパイプライン（Search→AIに質問→Save）を実行するハンドラー。
ーーーー
会社の製品概要、客層、地域などの基本情報、特性を設定。
過去の販売実績をアップロードし、AIが分析できるようにする。
販売実績データ、気象データ、景気データなどを組み合わせて、AIが分析、考察内容を人間に確認、気になる点を質問。
人間が回答、AIが予測値を調整、もしくは新たな質問をする。
予測モデルの完成。指定単位（例：一ヶ月）の製品別の需要予測値を出力。

受注が入ったら、実績データとしてシステムに取り込み、予測値と比較、乖離を分析→質問→予測モデルの改善を行う。
受注を分析する頻度は、週次、月次、手動など、業務に合わせて設定可能。


ーーーー
ここから下は、過去の内容です


# 需要予測システムのワークフロー案

このワークフローは、システムの主要機能がどのように連携し、担当者の日々の業務に組み込まれるかを示します。

## ステップ 1：データ投入と初期予測の生成 (自動・週次/月次)

システムは、事前に設定されたスケジュール（例：毎週月曜日、毎月 1 日）で、以下のデータの取り込みと初期分析を自動的に行います。

- 販売実績データの自動取り込み: 基幹システムや POS データから過去の販売実績データ（製品別、地域別など）が自動でシステムに連携されます。
- 外部データの自動連携:
  - 気象データ: 予測対象地域の過去の気温、降水量などが自動で取り込まれます。
  - 景気関連データ: 最新の経済指標（CPI、PMI など）が自動で連携されます。
- 初期予測値の生成と可視化:
  - AI はこれらのデータに基づき、基本的なトレンド、季節性を考慮した初期の需要予測値を生成します。
  - この初期予測は、グラフや表形式で分かりやすくダッシュボードに表示されます。過去の実績データと重ねて表示され、担当者は一目で全体像を把握できます。

## ステップ 2：AI による変動要因の特定と対話の開始 (自動/担当者確認)

システムは初期予測生成後、特に注目すべき点や疑問点を自動で検知し、担当者に問いかけます。

- 異常値・変動の検知と質問提示:
  - AI は、過去の販売実績や初期予測の中で、異常値・変動の検知と質問提示します。
  - これらの変動点に対し、AI は自動連携した外部データ（気象、景気）との相関を分析し、「この時期の急増は、例年にない高温と相関があります。何か関連はありますか？」のように仮説を提示しながら、担当者に対話形式で質問を投げかけます。
- 既存の社内ニュース・イベント情報との照合:
  - システムは、担当者が過去に登録した社内ニュースやイベント情報（例：新製品発売、プロモーション）を自動で変動期間と照合し、「この時期、新製品 A のキャンペーンが実施されていますが、それが影響しましたか？」と問いかけます。

## ステップ 3：担当者による情報入力と暗黙知の言語化 (担当者操作)

AI の質問に対し、担当者は自身の経験や知識を基に情報を提供・入力します。このプロセスを通じて暗黙知が引き出されます。

- 対話インターフェースでの回答:
  - 担当者は、AI が提示した質問に対し、チャット形式で回答します。
  - 「はい、この週はテレビで特集され、アクセスが急増しました」や「いいえ、気温は関係なく、主要顧客の棚替えによる一時的な発注増です」のように、具体的に回答します。
  - AI が漠然とした回答を受け取った場合、「具体的にはどのような情報に基づいてそう判断しましたか？」など、さらに深掘りする質問を投げかけます。
- 未登録の社内ニュース・イベント情報の新規登録:
  - 対話の中で、AI がアクセスできない社内情報（例：社外秘の競合情報、担当者しか知らない顧客との特約など）が判明した場合、担当者は「会社のニュース」機能を使ってその情報を新規登録できます。
  - 「〇月〇日、競合の ×× が新製品を発表。当社の A 製品に影響あり」「来月の △△ イベントにブース出展決定」など、具体的な内容、期間、影響度（定性評価可）を記入します。
- 手動入力による外部データの提供:
  - 為替レートの急変動や原材料価格の高騰など、AI が自動取得できないが重要な外部データについて、担当者は手動入力機能を使ってシステムに提供します。
- シナリオベースの仮説検証:
  - AI が提示する「もし来月、原材料価格が 10%上がったら、需要はどのくらい変わると思いますか？」といったシナリオに対し、担当者は選択肢（例：ほとんど影響なし、軽微な減少など）を選び、その理由を補足します。

## ステップ 4：予測値の調整と最終化 (AI 学習・担当者承認)

担当者からの入力や対話を通じて得られた情報に基づき、AI は予測モデルを調整し、最終予測値を提示します。

- AI による予測モデルの調整:
  - AI は、担当者との対話で得られた情報（イベントの影響度、要因の因果関係、手動入力データ）を既存のルールやモデルに組み込み、予測値を再計算します。
  - 特に、社内ニュースやイベント情報は、その後の実績と照合することで、AI がイベントの影響度を学習し、将来の同様のイベントに対する予測精度を高めます。
- 予測値の最終提示と確認:
  - AI は調整後の最終予測値を提示し、「担当者様の入力された『新製品 A キャンペーン』と『最近の景気指標の動向』を考慮し、来月の予測を〇〇に修正しました。ご確認ください。」と説明します。
  - 担当者は、提示された最終予測値と AI の説明を確認し、必要であれば最終的な微調整を行い、予測を確定させます。

## ステップ 5：実績との比較と継続的学習 (自動・定期実行)

予測確定後も、システムは継続的に学習を続けます。

- 実績データとの比較:
  - 期間が終了し、実際の販売実績データが確定すると、システムは予測値と実績を自動で比較し、その乖離を算出・可視化します。
- AI の学習とフィードバック:
  - 乖離が発生した場合、AI はその原因を探り、どの要因が予測に影響を与えたのか、またはどの情報が不足していたのかを分析します。
  - この分析結果は、次回の予測生成時や、対話時の AI の質問ロジックにフィードバックされ、システム全体の予測能力が継続的に向上していきます。
  - 「前回の予測は、登録されたキャンペーン効果を過大評価していました。次からは類似のキャンペーンがあった場合、その影響度を再評価します。」といった学習結果を担当者に通知することも可能です。